<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room - Sprint Story Point</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <script src="scripts/ws-client.js"></script>

    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: rgba(255, 255, 255, 0.04);
            --bg-card-hover: rgba(255, 255, 255, 0.08);
            --border-color: rgba(255, 255, 255, 0.12);
            --border-glow: rgba(79, 70, 229, 0.6);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #78859b;
            /* Shifted toward indigo for consistency with landing */
            --accent-primary: #4f46e5;
            --accent-secondary: #6366f1;
            --accent-cyan: #06b6d4;
            --accent-emerald: #10b981;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --glow-primary: rgba(79, 70, 229, 0.35);
            --glow-cyan: rgba(6, 182, 212, 0.35);
            --glow-emerald: rgba(16, 185, 129, 0.35);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            /* Reduced glow intensity ~15% for better contrast */
            background-image:
                radial-gradient(ellipse at 20% 0%, rgba(79, 70, 229, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 100%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
                radial-gradient(ellipse at 50% 50%, rgba(6, 182, 212, 0.03) 0%, transparent 60%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color: var(--text-primary);
        }

        /* Header */
        .room-header {
            background: rgba(10, 10, 15, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            padding: 16px 28px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .room-header h1 {
            font-size: 1.3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-primary) 50%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.02em;
        }

        .room-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .room-code {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 10px;
            font-family: 'SF Mono', 'JetBrains Mono', monospace;
            font-size: 0.9rem;
            font-weight: 700;
            letter-spacing: 1px;
            box-shadow: 0 4px 20px var(--glow-primary);
        }

        .header-btn {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: inherit;
        }

        .header-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--glow-primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            gap: 28px;
            padding: 28px;
            max-width: 1600px;
            margin: 0 auto;
            width: 100%;
        }

        .left-panel {
            flex: 1;
            min-width: 320px;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        .right-panel {
            width: 380px;
            display: flex;
            flex-direction: column;
            gap: 28px;
        }

        /* Panel Card */
        .panel {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 4px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--border-color);
            padding: 28px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .panel:hover {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 8px 50px rgba(0, 0, 0, 0.5), 0 0 40px var(--glow-primary);
        }

        .panel h3 {
            margin: 0 0 24px 0;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel h3 span {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: none;
            letter-spacing: 0;
        }

        /* Current Story */
        .story-title {
            font-size: 1.6rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.3;
            letter-spacing: -0.02em;
        }

        .story-notes {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 20px;
            line-height: 1.7;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 12px;
            border-left: 3px solid var(--accent-primary);
        }

        .phase-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 18px;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .phase-voting {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            color: var(--accent-primary);
            box-shadow: 0 0 20px var(--glow-primary);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .phase-revealed {
            background: linear-gradient(135deg, rgba(251, 146, 60, 0.2) 0%, rgba(245, 158, 11, 0.2) 100%);
            color: var(--accent-amber);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .phase-locked {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);
            color: var(--accent-emerald);
            box-shadow: 0 0 20px var(--glow-emerald);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        /* Voting Cards */
        .voting-section {
            margin: 32px 0;
        }

        .voting-section h4 {
            margin: 0 0 20px 0;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .voting-cards {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            justify-content: center;
            perspective: 1000px;
        }

        .vote-card {
            width: 72px;
            height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: 800;
            /* High contrast border */
            border: 2px solid rgba(255, 255, 255, 0.25);
            border-radius: 16px;
            cursor: pointer;
            /* Brighter background for clear clickability */
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
            color: var(--text-primary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .vote-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            opacity: 0;
            transition: opacity 0.2s;
        }

        .vote-card::after {
            content: '';
            position: absolute;
            inset: -50%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.2), transparent 30%);
            animation: card-shine 3s linear infinite;
            opacity: 0;
            transition: opacity 0.2s;
        }

        @keyframes card-shine {
            to { transform: rotate(360deg); }
        }

        .vote-card:hover:not(:disabled) {
            border-color: var(--accent-secondary);
            transform: translateY(-6px) scale(1.05);
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
            box-shadow:
                0 16px 32px rgba(79, 70, 229, 0.3),
                0 0 0 2px rgba(99, 102, 241, 0.6);
        }

        .vote-card:hover:not(:disabled)::after {
            opacity: 1;
        }

        .vote-card:active:not(:disabled) {
            transform: translateY(-2px) scale(1.02);
        }

        .vote-card.selected {
            border-color: white;
            color: white;
            transform: translateY(-4px) scale(1.05);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            box-shadow:
                0 12px 28px rgba(79, 70, 229, 0.5),
                0 0 0 3px white,
                0 0 30px var(--glow-primary);
        }

        .vote-card.selected::before {
            opacity: 0;
        }

        .vote-card.selected span {
            position: relative;
            z-index: 1;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            font-size: 1.6rem;
        }

        .vote-card.selected:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow:
                0 14px 32px rgba(79, 70, 229, 0.55),
                0 0 0 3px white,
                0 0 35px var(--glow-primary);
        }

        .vote-card:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
        }

        .vote-card:disabled:hover {
            transform: none !important;
            border-color: rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.03);
        }

        /* Statistics */
        .stats-panel {
            display: none;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 20px;
            padding: 24px;
            margin-top: 28px;
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
        }

        .stats-panel.show {
            display: block;
            animation: fadeSlideIn 0.4s ease;
        }

        @keyframes fadeSlideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-panel h4 {
            margin: 0 0 20px 0;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--accent-primary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            text-align: center;
        }

        .stat-item {
            padding: 16px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .stat-item:hover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-top: 6px;
        }

        /* Host Controls */
        .host-controls {
            display: none;
            margin-top: 28px;
            padding-top: 28px;
            border-top: 1px solid var(--border-color);
        }

        .host-controls.show {
            display: block;
        }

        .host-controls h4 {
            margin: 0 0 18px 0;
            color: var(--text-muted);
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .host-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .host-btn {
            padding: 12px 22px;
            border: 1px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.85rem;
            font-family: inherit;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .host-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            box-shadow: 0 4px 20px var(--glow-primary);
        }

        .host-btn.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--glow-primary);
        }

        .host-btn.secondary {
            background: var(--bg-card);
            border-color: var(--border-color);
            color: var(--text-secondary);
        }

        .host-btn.secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .host-btn.tertiary {
            background: transparent;
            border-color: transparent;
            color: var(--text-muted);
            padding: 12px 16px;
        }

        .host-btn.tertiary:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-secondary);
        }

        .host-btn.primary.large {
            padding: 14px 28px;
            font-size: 0.95rem;
        }

        /* Quick-pick chips for Lock */
        .footer-quick-picks {
            display: flex;
            gap: 6px;
            margin-right: 8px;
        }

        .quick-pick-chip {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .quick-pick-chip:hover {
            background: rgba(79, 70, 229, 0.15);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .quick-pick-chip.recommended {
            background: rgba(16, 185, 129, 0.1);
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--accent-emerald);
        }

        .quick-pick-chip.recommended:hover {
            background: rgba(16, 185, 129, 0.2);
        }

        .host-btn.danger {
            background: linear-gradient(135deg, var(--accent-rose) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(244, 63, 94, 0.3);
        }

        .host-btn.danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(244, 63, 94, 0.4);
        }

        .host-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none !important;
        }

        .host-btn.auto-calc {
            background: linear-gradient(135deg, var(--accent-emerald) 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 20px var(--glow-emerald);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .host-btn.auto-calc:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--glow-emerald);
        }

        .host-btn.auto-calc .auto-calc-icon {
            font-size: 1.1rem;
        }

        .host-btn.ai-suggest {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            box-shadow: 0 4px 20px var(--glow-primary);
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .host-btn.ai-suggest:hover:not(.disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--glow-primary);
        }

        .host-btn.ai-suggest .ai-icon {
            font-size: 1.1rem;
        }

        .host-btn.ai-suggest .pro-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #0a0a0f;
            font-size: 0.55rem;
            font-weight: 800;
            padding: 3px 6px;
            border-radius: 4px;
            margin-left: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .host-btn.ai-suggest.disabled {
            opacity: 0.6;
            cursor: pointer;
            background: linear-gradient(135deg, #475569 0%, #334155 100%);
            box-shadow: none;
        }

        .host-btn.ai-suggest.disabled:hover {
            transform: none;
            opacity: 0.7;
        }

        /* Purchase Modal */
        .purchase-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .purchase-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .purchase-modal {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 40px;
            max-width: 420px;
            width: 90%;
            text-align: center;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 50px var(--glow-primary);
            border: 1px solid var(--border-color);
        }

        .purchase-modal-overlay.visible .purchase-modal {
            transform: scale(1) translateY(0);
        }

        .purchase-modal-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 24px;
            font-size: 2.5rem;
            box-shadow: 0 8px 30px var(--glow-primary);
        }

        .purchase-modal h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .purchase-modal p {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .purchase-modal-features {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: left;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .purchase-modal-features ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .purchase-modal-features li {
            padding: 10px 0;
            color: var(--text-secondary);
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .purchase-modal-features li::before {
            content: "✓";
            color: var(--accent-emerald);
            font-weight: 700;
            text-shadow: 0 0 10px var(--glow-emerald);
        }

        .purchase-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .purchase-modal-btn {
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-family: inherit;
        }

        .purchase-modal-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            box-shadow: 0 4px 20px var(--glow-primary);
        }

        .purchase-modal-btn.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--glow-primary);
        }

        .purchase-modal-btn.secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .purchase-modal-btn.secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
        }

        /* Participants - Virtual Poker Table Style */
        .participants-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 16px;
            padding: 20px;
            background: radial-gradient(ellipse at center, rgba(16, 185, 129, 0.1) 0%, transparent 70%);
            border-radius: 50% / 30%;
            min-height: 200px;
            position: relative;
        }

        .participants-grid::before {
            content: '';
            position: absolute;
            inset: 10px;
            border: 2px dashed rgba(16, 185, 129, 0.2);
            border-radius: 50% / 30%;
            pointer-events: none;
        }

        .participant-card {
            text-align: center;
            padding: 16px 14px;
            background: var(--bg-card);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-width: 100px;
        }

        .participant-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            box-shadow: 0 8px 30px var(--glow-primary);
        }

        .participant-card.current-user {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border: 2px solid var(--accent-primary);
            box-shadow: 0 0 30px var(--glow-primary);
        }

        .participant-avatar {
            font-size: 2.4rem;
            margin-bottom: 10px;
            line-height: 1;
            transition: transform 0.3s;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .participant-avatar.clickable {
            cursor: pointer;
        }

        .participant-avatar.clickable:hover {
            transform: scale(1.2) rotate(5deg);
        }

        .participant-card.current-user .participant-avatar {
            position: relative;
        }

        .participant-card.current-user .participant-avatar::after {
            content: "✎";
            font-size: 0.55rem;
            position: absolute;
            bottom: -2px;
            right: -2px;
            background: var(--accent-primary);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 2px 8px var(--glow-primary);
        }

        .participant-card.current-user:hover .participant-avatar::after {
            opacity: 1;
        }

        .participant-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .participant-vote {
            width: 54px;
            height: 72px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--text-muted);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .participant-vote::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-primary) 50%, var(--accent-secondary) 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .participant-vote.voted {
            border-color: transparent;
            box-shadow: 0 4px 20px var(--glow-primary);
        }

        .participant-vote.voted::before {
            opacity: 1;
        }

        .participant-vote.voted span {
            position: relative;
            z-index: 1;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .participant-vote.revealed {
            background: var(--bg-card);
            border-color: var(--accent-cyan);
            color: var(--accent-cyan);
            box-shadow: 0 0 20px var(--glow-cyan);
        }

        .participant-vote.revealed::before {
            opacity: 0;
        }

        /* Stories List */
        .stories-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .stories-list::-webkit-scrollbar {
            width: 6px;
        }

        .stories-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 3px;
        }

        .stories-list::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
        }

        .stories-list::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        .story-item {
            padding: 14px 16px;
            border: 1px solid var(--border-color);
            border-radius: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg-card);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .story-item:hover {
            border-color: var(--accent-primary);
            box-shadow: 0 4px 20px var(--glow-primary);
            transform: translateX(4px);
        }

        .story-item.active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border-color: var(--accent-primary);
            box-shadow: 0 0 30px var(--glow-primary);
        }

        .story-item.locked {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border-color: var(--accent-emerald);
            box-shadow: 0 0 20px var(--glow-emerald);
        }

        .story-item-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 0.95rem;
            word-break: break-word;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 6px;
        }

        .story-item-estimate {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .story-item-estimate .value {
            font-weight: 700;
            color: var(--accent-emerald);
            text-shadow: 0 0 10px var(--glow-emerald);
        }

        /* Add Story Form */
        .add-story-form {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .add-story-form input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.3s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .add-story-form input::placeholder {
            color: var(--text-muted);
        }

        .add-story-form input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--glow-primary);
        }

        .add-story-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.3s;
            box-shadow: 0 4px 15px var(--glow-primary);
        }

        .add-story-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--glow-primary);
        }

        /* Import Stories */
        .import-stories {
            margin-top: 12px;
        }

        .import-btn {
            width: 100%;
            padding: 12px 16px;
            background: transparent;
            color: var(--text-muted);
            border: 2px dashed rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            font-family: inherit;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .import-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 20px var(--glow-primary);
        }

        /* Story Actions */
        .story-actions {
            display: flex;
            gap: 6px;
            margin-left: auto;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .story-item:hover .story-actions {
            opacity: 1;
        }

        .story-action-btn {
            width: 30px;
            height: 30px;
            padding: 0;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
        }

        .story-action-btn:hover {
            transform: scale(1.15);
            border-color: var(--accent-primary);
        }

        .story-action-btn.edit:hover {
            color: var(--accent-primary);
            box-shadow: 0 0 15px var(--glow-primary);
        }

        .story-action-btn.notes:hover {
            color: var(--accent-amber);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.3);
        }

        .story-action-btn.delete:hover {
            color: var(--accent-rose);
            border-color: var(--accent-rose);
            box-shadow: 0 0 15px rgba(244, 63, 94, 0.3);
        }

        .story-action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none !important;
        }

        .story-item.locked .story-actions {
            opacity: 0.4;
        }

        /* Edit Story Modal */
        .edit-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .edit-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .edit-modal {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px var(--glow-primary);
            border: 1px solid var(--border-color);
        }

        .edit-modal-overlay.visible .edit-modal {
            transform: scale(1) translateY(0);
        }

        .edit-modal h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 20px;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .edit-modal-field {
            margin-bottom: 16px;
        }

        .edit-modal-field label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .edit-modal-field input,
        .edit-modal-field textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.3s;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .edit-modal-field input::placeholder,
        .edit-modal-field textarea::placeholder {
            color: var(--text-muted);
        }

        .edit-modal-field input:focus,
        .edit-modal-field textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--glow-primary);
        }

        .edit-modal-field textarea {
            min-height: 100px;
            resize: vertical;
        }

        .edit-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .edit-modal-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-family: inherit;
        }

        .edit-modal-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            box-shadow: 0 4px 20px var(--glow-primary);
        }

        .edit-modal-btn.primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--glow-primary);
        }

        .edit-modal-btn.secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .edit-modal-btn.secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
        }

        .edit-modal-btn.danger {
            background: linear-gradient(135deg, var(--accent-rose) 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(244, 63, 94, 0.3);
        }

        .edit-modal-btn.danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(244, 63, 94, 0.4);
        }

        .edit-modal .locked-notice {
            background: linear-gradient(135deg, rgba(244, 63, 94, 0.15) 0%, rgba(220, 38, 38, 0.15) 100%);
            color: var(--accent-rose);
            padding: 14px 18px;
            border-radius: 12px;
            font-size: 0.9rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            border: 1px solid rgba(244, 63, 94, 0.3);
        }

        /* Notes indicator on story item */
        .story-has-notes {
            font-size: 0.75rem;
            color: var(--accent-amber);
            margin-left: 6px;
            text-shadow: 0 0 10px rgba(245, 158, 11, 0.5);
        }

        /* Avatar Selector Modal */
        .avatar-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .avatar-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .avatar-modal {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            transform: scale(0.9) translateY(20px);
            transition: transform 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 40px var(--glow-primary);
            border: 1px solid var(--border-color);
        }

        .avatar-modal::-webkit-scrollbar {
            width: 6px;
        }

        .avatar-modal::-webkit-scrollbar-track {
            background: transparent;
        }

        .avatar-modal::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
        }

        .avatar-modal-overlay.visible .avatar-modal {
            transform: scale(1) translateY(0);
        }

        .avatar-modal h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-align: center;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-primary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .avatar-modal-subtitle {
            text-align: center;
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 20px;
        }

        .avatar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(54px, 1fr));
            gap: 10px;
            margin-bottom: 24px;
        }

        .avatar-option {
            width: 54px;
            height: 54px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s;
            background: var(--bg-card);
            position: relative;
        }

        .avatar-option:hover:not(.disabled):not(.selected) {
            border-color: var(--accent-primary);
            transform: scale(1.15);
            box-shadow: 0 8px 25px var(--glow-primary);
        }

        .avatar-option.selected {
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            box-shadow: 0 0 0 3px var(--glow-primary);
        }

        .avatar-option.disabled {
            opacity: 0.25;
            cursor: not-allowed;
            background: var(--bg-primary);
        }

        .avatar-option.disabled::after {
            content: "";
            position: absolute;
            width: 100%;
            height: 2px;
            background: var(--accent-rose);
            transform: rotate(-45deg);
        }

        .avatar-modal-footer {
            display: flex;
            justify-content: center;
            gap: 12px;
        }

        .avatar-modal-btn {
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-family: inherit;
        }

        .avatar-modal-btn.secondary {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .avatar-modal-btn.secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        /* Connection Status */
        .connection-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--accent-rose);
            box-shadow: 0 0 0 3px rgba(244, 63, 94, 0.2), 0 0 12px rgba(244, 63, 94, 0.5);
            animation: pulse-dot 2s ease-in-out infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .status-dot.connected {
            background: var(--accent-emerald);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2), 0 0 12px var(--glow-emerald);
        }

        .status-dot.reconnecting {
            background: var(--accent-amber);
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2), 0 0 12px rgba(245, 158, 11, 0.5);
            animation: pulse-reconnect 1s ease-in-out infinite;
        }

        @keyframes pulse-reconnect {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
        }

        /* Connection Lost State */
        body.connection-lost .room-main {
            opacity: 0.7;
            pointer-events: none;
        }

        body.connection-lost::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.1);
            pointer-events: none;
            z-index: 999;
        }

        /* Connection Toast */
        .connection-toast {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: toast-in 0.3s ease-out;
        }

        .connection-toast.warning {
            border-color: var(--accent-amber);
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), var(--bg-secondary));
        }

        .connection-toast.error {
            border-color: var(--accent-rose);
            background: linear-gradient(135deg, rgba(244, 63, 94, 0.1), var(--bg-secondary));
        }

        .connection-toast.fade-out {
            animation: toast-out 0.3s ease-in forwards;
        }

        @keyframes toast-in {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }

        @keyframes toast-out {
            from { opacity: 1; transform: translateX(-50%) translateY(0); }
            to { opacity: 0; transform: translateX(-50%) translateY(-20px); }
        }

        .toast-icon {
            font-size: 1.2rem;
        }

        .toast-message {
            color: var(--text-primary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 4px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .toast-close:hover {
            opacity: 1;
        }

        /* Share Dropdown */
        .share-dropdown {
            position: relative;
        }

        .share-menu {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: var(--bg-secondary);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4), 0 0 30px var(--glow-primary);
            min-width: 220px;
            z-index: 200;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .share-menu.show {
            display: block;
            animation: slideDown 0.25s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .share-option {
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
            padding: 14px 18px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            font-family: inherit;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .share-option:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            color: var(--text-primary);
        }

        .share-option span {
            font-size: 1.2rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .modal-overlay.hidden {
            display: none;
        }

        .modal-box {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 24px;
            width: 100%;
            max-width: 420px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 50px var(--glow-primary);
            border: 1px solid var(--border-color);
            animation: modalSlideUp 0.3s ease;
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-box h2 {
            margin: 0 0 10px 0;
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-primary) 50%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-box p {
            color: var(--text-secondary);
            margin-bottom: 28px;
            font-size: 0.95rem;
        }

        .modal-box input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            font-size: 1rem;
            font-family: inherit;
            margin-bottom: 18px;
            transition: all 0.3s;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .modal-box input::placeholder {
            color: var(--text-muted);
        }

        .modal-box input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px var(--glow-primary);
        }

        .modal-box button {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 20px var(--glow-primary);
        }

        .modal-box button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--glow-primary);
        }

        /* Error State */
        .error-container {
            display: none;
            text-align: center;
            padding: 80px 20px;
        }

        .error-container.show {
            display: block;
        }

        .error-container h2 {
            color: var(--accent-rose);
            margin-bottom: 16px;
            font-size: 1.8rem;
            text-shadow: 0 0 30px rgba(244, 63, 94, 0.4);
        }

        .error-container p {
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .error-container a {
            display: inline-block;
            padding: 14px 32px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            text-decoration: none;
            border-radius: 14px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 4px 20px var(--glow-primary);
        }

        .error-container a:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px var(--glow-primary);
        }

        /* Loading State */
        .loading-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            flex: 1;
        }

        .loading-container.hidden {
            display: none;
        }

        .loading-spinner {
            width: 52px;
            height: 52px;
            border: 4px solid rgba(99, 102, 241, 0.2);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            box-shadow: 0 0 30px var(--glow-primary);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Waiting indicator */
        .waiting-count {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 14px;
            text-align: center;
            font-weight: 500;
        }

        /* Settings Panel */
        .form-control {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.3s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--glow-primary);
        }

        .settings-section {
            margin-bottom: 20px;
        }

        .settings-section label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
            padding: 12px 16px;
            background: var(--bg-card);
            border-radius: 12px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .checkbox-label:hover {
            border-color: var(--accent-primary);
            background: var(--bg-card-hover);
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--accent-primary);
        }

        /* Chat Panel */
        .chat-panel {
            display: flex;
            flex-direction: column;
            max-height: 420px;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            min-height: 180px;
            max-height: 280px;
            border-radius: 12px;
            padding: 12px;
            margin-bottom: 12px;
            background: var(--bg-primary);
            border: 1px solid rgba(99, 102, 241, 0.12);
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.3);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        .chat-message {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            padding: 10px 12px;
            background: var(--bg-card);
            border-radius: 14px;
            border: 1px solid var(--border-color);
            animation: messageSlide 0.25s ease;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.own {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            margin-left: 20px;
            border-color: rgba(99, 102, 241, 0.3);
        }

        .chat-message-avatar {
            flex-shrink: 0;
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }

        .chat-message.own .chat-message-avatar {
            background: rgba(255, 255, 255, 0.2);
        }

        .chat-message-content {
            flex: 1;
            min-width: 0;
        }

        .chat-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
        }

        .chat-message-name {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--accent-cyan);
        }

        .chat-message-time {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .chat-message-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            word-wrap: break-word;
            line-height: 1.4;
        }

        .chat-empty {
            text-align: center;
            padding: 20px 16px;
            color: var(--text-muted);
        }

        .chat-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
            opacity: 0.7;
        }

        .chat-empty-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .chat-empty-subtitle {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: 20px;
        }

        .chat-quick-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .chat-chip {
            padding: 8px 14px;
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.25);
            border-radius: 20px;
            color: var(--accent-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .chat-chip:hover {
            background: rgba(79, 70, 229, 0.2);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .chat-privacy-note {
            font-size: 0.7rem;
            color: var(--text-muted);
            opacity: 0.7;
            line-height: 1.4;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 14px;
            font-size: 0.9rem;
            font-family: inherit;
            transition: all 0.3s;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px var(--glow-primary);
        }

        .chat-send-btn {
            padding: 14px 22px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-weight: 600;
            font-family: inherit;
            transition: all 0.3s;
            box-shadow: 0 4px 15px var(--glow-primary);
        }

        .chat-send-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--glow-primary);
        }

        .chat-send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .chat-badge {
            background: linear-gradient(135deg, var(--accent-rose) 0%, #dc2626 100%);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 12px;
            margin-left: 8px;
            display: none;
            box-shadow: 0 2px 10px rgba(244, 63, 94, 0.4);
        }

        .chat-badge.show {
            display: inline;
        }

        /* No story state */
        .no-story-state {
            text-align: center;
            padding: 52px 24px;
            color: var(--text-muted);
        }

        .no-story-state p:first-child {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .right-panel {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 640px) {
            .room-header {
                padding: 12px 16px;
            }

            .room-header h1 {
                font-size: 1.1rem;
            }

            .main-content {
                padding: 16px;
            }

            .panel {
                padding: 18px;
                border-radius: 16px;
            }

            .vote-card {
                width: 56px;
                height: 75px;
                font-size: 1.2rem;
            }

            .participants-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            }

            .chat-messages {
                max-height: 220px;
            }
        }

        /* ============ FUN ELEMENTS ============ */

        /* Confetti Container */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }

        .confetti.circle {
            border-radius: 50%;
        }

        .confetti.square {
            border-radius: 2px;
        }

        .confetti.triangle {
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 10px solid currentColor;
            background: transparent !important;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(-100px) rotate(0deg) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg) scale(0.5);
            }
        }

        /* Celebration Overlay */
        .celebration-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9998;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .celebration-overlay.show {
            opacity: 1;
        }

        .celebration-message {
            background: var(--bg-secondary);
            backdrop-filter: blur(20px);
            padding: 44px 64px;
            border-radius: 28px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5), 0 0 60px var(--glow-primary);
            border: 1px solid var(--border-color);
            transform: scale(0.8);
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .celebration-overlay.show .celebration-message {
            transform: scale(1);
        }

        .celebration-emoji {
            font-size: 4.5rem;
            margin-bottom: 18px;
            animation: bounce 0.6s ease infinite;
            filter: drop-shadow(0 4px 20px rgba(99, 102, 241, 0.4));
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-12px); }
        }

        .celebration-text {
            font-size: 1.6rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan) 0%, var(--accent-primary) 50%, var(--accent-secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .celebration-subtext {
            color: var(--text-secondary);
            margin-top: 10px;
            font-size: 1rem;
        }

        /* Vote Card Fun Animation */
        .vote-card.just-voted {
            animation: cardPop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes cardPop {
            0% { transform: scale(1); }
            50% { transform: scale(1.15) rotate(5deg); }
            100% { transform: scale(1); }
        }

        /* Participant Vote Animation */
        .participant-vote.just-voted {
            animation: voteReveal 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes voteReveal {
            0% { transform: scale(0) rotateY(180deg); }
            100% { transform: scale(1) rotateY(0deg); }
        }

        /* Consensus Glow */
        .consensus-glow {
            animation: consensusGlow 2s ease-in-out infinite;
        }

        @keyframes consensusGlow {
            0%, 100% { box-shadow: 0 0 20px rgba(34, 197, 94, 0.3); }
            50% { box-shadow: 0 0 40px rgba(34, 197, 94, 0.6); }
        }

        /* Emoji Reaction Floating */
        .emoji-float {
            position: fixed;
            font-size: 2rem;
            pointer-events: none;
            z-index: 9999;
            animation: emojiFloat 2s ease-out forwards;
        }

        @keyframes emojiFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-150px) scale(1.5);
            }
        }

        /* All Voted Pulse */
        .all-voted-pulse {
            animation: allVotedPulse 1s ease-in-out infinite;
        }

        @keyframes allVotedPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        /* Waiting Dots Animation */
        .waiting-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* Story Lock Animation */
        .story-item.just-locked {
            animation: storyLock 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        @keyframes storyLock {
            0% { transform: scale(1); }
            30% { transform: scale(1.05); background: rgba(34, 197, 94, 0.2); }
            100% { transform: scale(1); }
        }

        /* Emoji Reaction Bar */
        .emoji-reactions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 18px;
            flex-wrap: wrap;
        }

        .emoji-reaction-btn {
            width: 48px;
            height: 48px;
            border: 1px solid var(--border-color);
            background: var(--bg-card);
            border-radius: 14px;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-reaction-btn:hover {
            transform: scale(1.2);
            border-color: var(--accent-primary);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%);
            box-shadow: 0 8px 25px var(--glow-primary);
        }

        .emoji-reaction-btn:active {
            transform: scale(0.9);
        }

        /* Fortune Cookie Toast - positioned top-right to avoid footer */
        .fortune-toast {
            position: fixed;
            top: 80px;
            right: 24px;
            transform: translateX(100px);
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.12) 0%, rgba(99, 102, 241, 0.12) 100%);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3), 0 0 30px rgba(79, 70, 229, 0.15);
            z-index: 9997;
            max-width: 340px;
            width: auto;
            opacity: 0;
            visibility: hidden;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            backdrop-filter: blur(12px);
        }

        .fortune-toast.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
        }

        .fortune-emoji {
            font-size: 1.8rem;
            flex-shrink: 0;
            animation: fortuneWiggle 0.6s ease-in-out;
        }

        @keyframes fortuneWiggle {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-12deg); }
            75% { transform: rotate(12deg); }
        }

        .fortune-content {
            flex: 1;
        }

        .fortune-label {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent-secondary);
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fortune-label::before {
            content: "🥠";
            font-size: 0.85rem;
        }

        .fortune-text {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.4;
            font-style: italic;
        }

        .fortune-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px;
            opacity: 0.6;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .fortune-close:hover {
            opacity: 1;
            color: var(--text-primary);
        }

        /* Mobile adjustments */
        @media (max-width: 640px) {
            .fortune-toast {
                top: auto;
                bottom: 120px;
                right: 16px;
                left: 16px;
                transform: translateY(100px);
                max-width: none;
            }

            .fortune-toast.show {
                transform: translateY(0);
            }

            .fortune-text {
                font-size: 0.85rem;
            }
        }

        /* ============================================
           FOCUSED LAYOUT: 3 Zones + Drawer
           ============================================ */

        /* Drawer Variables */
        :root {
            --drawer-width: 360px;
            --drawer-z-index: 500;
            --card-width: 80px;
            --card-height: 110px;
            --card-width-mobile: 64px;
            --card-height-mobile: 88px;
        }

        /* Wider drawer on large screens */
        @media (min-width: 1440px) {
            :root {
                --drawer-width: 400px;
            }
        }

        /* Smaller drawer on medium screens */
        @media (max-width: 1024px) {
            :root {
                --drawer-width: 340px;
            }
        }

        /* Compact drawer on small screens */
        @media (max-width: 900px) {
            :root {
                --drawer-width: 320px;
            }
        }

        /* Drawer Overlay */
        .drawer-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            -webkit-backdrop-filter: blur(4px);
            z-index: calc(var(--drawer-z-index) - 1);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .drawer-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        /* Drawer Panel */
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: var(--drawer-width);
            height: 100vh;
            background: var(--bg-secondary);
            border-left: 1px solid var(--border-color);
            z-index: var(--drawer-z-index);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 40px rgba(0, 0, 0, 0.4);
        }

        .drawer.open {
            transform: translateX(0);
        }

        /* Drawer Header */
        .drawer-header {
            display: flex;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            gap: 8px;
            background: rgba(10, 10, 15, 0.5);
        }

        .drawer-tabs {
            display: flex;
            gap: 4px;
            flex: 1;
            overflow-x: auto;
        }

        .drawer-tab {
            padding: 10px 14px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 10px;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            white-space: nowrap;
            font-family: inherit;
        }

        .drawer-tab:hover {
            color: var(--text-primary);
            background: var(--bg-card);
        }

        .drawer-tab.active {
            color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
        }

        .drawer-tab-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            background: var(--accent-rose);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            border-radius: 9px;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        .drawer-tab-badge.show {
            display: flex;
        }

        .drawer-close {
            width: 36px;
            height: 36px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 1.4rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
        }

        .drawer-close:hover {
            background: var(--accent-rose);
            color: white;
            border-color: var(--accent-rose);
        }

        /* Drawer Content */
        .drawer-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .drawer-panel {
            position: absolute;
            inset: 0;
            padding: 20px;
            overflow-y: auto;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s;
        }

        .drawer-panel.active {
            opacity: 1;
            visibility: visible;
        }

        .drawer-panel h4 {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 16px 0;
        }

        /* Room Info Box */
        .room-info-box {
            background: rgba(79, 70, 229, 0.08);
            border: 1px solid rgba(79, 70, 229, 0.2);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 20px;
        }

        .room-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            padding: 4px 0;
        }

        .room-info-label {
            color: var(--text-muted);
        }

        .room-info-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .room-info-value.host {
            color: var(--accent-emerald);
        }

        /* Section divider */
        .drawer-section {
            border-top: 1px solid var(--border-color);
            padding-top: 20px;
            margin-top: 20px;
        }

        .drawer-section:first-child {
            border-top: none;
            padding-top: 0;
            margin-top: 0;
        }

        /* Host-only badge */
        .host-only-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--accent-amber);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-left: 8px;
        }

        /* Danger Zone styling */
        .danger-zone {
            background: rgba(244, 63, 94, 0.05);
            border: 1px solid rgba(244, 63, 94, 0.15);
            border-radius: 12px;
            padding: 16px;
            margin-top: 24px;
        }

        .danger-zone h4 {
            color: var(--accent-rose);
            margin-bottom: 12px;
        }

        .danger-zone-btn {
            width: 100%;
            padding: 12px 20px;
            background: transparent;
            border: 1px solid rgba(244, 63, 94, 0.4);
            border-radius: 10px;
            color: var(--accent-rose);
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .danger-zone-btn:hover {
            background: rgba(244, 63, 94, 0.1);
            border-color: var(--accent-rose);
        }

        /* Confirmation Modal */
        .confirm-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .confirm-modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .confirm-modal {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            transform: scale(0.9);
            transition: transform 0.3s;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            border: 1px solid var(--border-color);
        }

        .confirm-modal-overlay.visible .confirm-modal {
            transform: scale(1);
        }

        .confirm-modal-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .confirm-modal h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }

        .confirm-modal p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .confirm-modal-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.2s;
        }

        .confirm-modal-input:focus {
            outline: none;
            border-color: var(--accent-rose);
        }

        .confirm-modal-input::placeholder {
            color: var(--text-muted);
        }

        .confirm-modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .confirm-modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }

        .confirm-modal-btn.cancel {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .confirm-modal-btn.cancel:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .confirm-modal-btn.danger {
            background: linear-gradient(135deg, var(--accent-rose) 0%, #dc2626 100%);
            color: white;
        }

        .confirm-modal-btn.danger:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(244, 63, 94, 0.4);
        }

        .confirm-modal-btn.danger:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Drawer Toggle Button */
        .drawer-toggle {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            width: 44px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-right: none;
            border-radius: 12px 0 0 12px;
            cursor: pointer;
            z-index: calc(var(--drawer-z-index) - 2);
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 6px;
            gap: 8px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .drawer-toggle:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            width: 52px;
        }

        .drawer-toggle-item {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .drawer-toggle:hover .drawer-toggle-item {
            opacity: 1;
        }

        .drawer-toggle-item.has-badge {
            opacity: 1;
        }

        .drawer-toggle-item .badge-count {
            position: absolute;
            top: -6px;
            right: -8px;
            min-width: 14px;
            height: 14px;
            padding: 0 4px;
            background: var(--accent-primary);
            color: white;
            font-size: 0.6rem;
            font-weight: 700;
            border-radius: 7px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .drawer-toggle-item .badge-dot {
            position: absolute;
            top: -2px;
            right: -4px;
            width: 8px;
            height: 8px;
            background: var(--accent-rose);
            border-radius: 50%;
            animation: pulse-badge 2s infinite;
        }

        .drawer-toggle-divider {
            width: 16px;
            height: 1px;
            background: var(--border-color);
        }

        @keyframes pulse-badge {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.2); }
        }

        .drawer.open ~ .drawer-toggle {
            opacity: 0;
            pointer-events: none;
        }

        /* ============================================
           3-Zone Main Layout
           ============================================ */

        .room-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 24px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            gap: 20px;
        }

        /* Zone A: Current Story */
        .zone-story {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border-color);
            transition: all 0.3s;
        }

        .zone-story:hover {
            border-color: rgba(99, 102, 241, 0.3);
        }

        .zone-story.empty {
            text-align: center;
            /* Reduced height ~20% */
            padding: 24px 20px;
            /* Better contrast for empty state */
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed rgba(255, 255, 255, 0.18);
        }

        .zone-story.empty .empty-message {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 500;
        }

        .zone-story.empty .empty-hint {
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 6px;
        }

        .zone-story.empty .empty-action {
            margin-top: 12px;
        }

        .zone-story.empty .open-drawer-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .zone-story.empty .open-drawer-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--glow-primary);
        }

        .zone-story.empty .open-drawer-btn svg {
            width: 14px;
            height: 14px;
        }

        .story-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
            flex-wrap: wrap;
        }

        .story-title-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 200px;
        }

        .story-number-badge {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.2), rgba(99, 102, 241, 0.2));
            border: 1px solid rgba(79, 70, 229, 0.3);
            color: var(--accent-secondary);
            font-size: 0.75rem;
            font-weight: 700;
            padding: 4px 10px;
            border-radius: 6px;
            white-space: nowrap;
        }

        .zone-story .story-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin: 0;
            line-height: 1.3;
        }

        .zone-story .story-title[contenteditable="true"] {
            outline: none;
            border-radius: 8px;
            padding: 4px 8px;
            margin: -4px -8px;
            transition: all 0.2s;
        }

        .zone-story .story-title[contenteditable="true"]:focus {
            background: rgba(99, 102, 241, 0.1);
            box-shadow: 0 0 0 2px var(--accent-primary);
        }

        .story-edit-btn {
            opacity: 0;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .story-title-wrapper:hover .story-edit-btn {
            opacity: 0.6;
        }

        .story-edit-btn:hover {
            opacity: 1 !important;
            background: var(--bg-card-hover);
        }

        .story-progress {
            margin-top: 16px;
            padding: 12px 16px;
            background: rgba(79, 70, 229, 0.08);
            border: 1px solid rgba(79, 70, 229, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .story-progress-text {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .story-progress-bar {
            flex: 1;
            max-width: 180px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .story-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-cyan));
            border-radius: 4px;
            transition: width 0.3s;
        }

        .story-progress.waiting .story-progress-text {
            color: var(--accent-primary);
        }

        .story-progress.invite {
            background: linear-gradient(135deg, rgba(6, 182, 212, 0.1), rgba(79, 70, 229, 0.1));
            border-color: rgba(6, 182, 212, 0.3);
        }

        .story-progress.invite .story-progress-text {
            color: var(--accent-cyan);
        }

        .invite-link-btn {
            background: var(--accent-cyan);
            color: #0a0a0f;
            border: none;
            padding: 6px 14px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .invite-link-btn:hover {
            background: #22d3ee;
            transform: translateY(-1px);
        }

        /* Inline stats shown in story zone after reveal */
        .story-stats-inline {
            display: none;
            margin-top: 16px;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.1), rgba(99, 102, 241, 0.1));
            border: 1px solid rgba(79, 70, 229, 0.25);
            border-radius: 12px;
            gap: 20px;
            align-items: center;
            flex-wrap: wrap;
        }

        .story-stats-inline.show {
            display: flex;
            animation: fadeSlideIn 0.3s ease;
        }

        .story-stats-inline.consensus {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(5, 150, 105, 0.12));
            border-color: rgba(16, 185, 129, 0.3);
        }

        .stats-inline-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .stats-inline-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-inline-value {
            font-size: 1rem;
            font-weight: 800;
            color: var(--accent-secondary);
        }

        .story-stats-inline.consensus .stats-inline-value {
            color: var(--accent-emerald);
        }

        .consensus-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: var(--accent-emerald);
            font-size: 0.95rem;
        }

        .consensus-badge::before {
            content: '✓';
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            background: var(--accent-emerald);
            color: white;
            border-radius: 50%;
            font-size: 0.7rem;
        }

        /* Contextual CTA chips */
        .context-cta-chips {
            margin-top: 12px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .context-cta-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.25);
            border-radius: 20px;
            color: var(--accent-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .context-cta-chip:hover {
            background: rgba(79, 70, 229, 0.2);
            border-color: var(--accent-primary);
            transform: translateY(-1px);
        }

        .context-cta-chip.discuss {
            background: rgba(244, 114, 182, 0.1);
            border-color: rgba(244, 114, 182, 0.3);
            color: #f472b6;
        }

        .context-cta-chip.discuss:hover {
            background: rgba(244, 114, 182, 0.2);
            border-color: #f472b6;
        }

        .story-notes-collapse {
            margin-top: 16px;
        }

        .story-notes-collapse summary {
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            user-select: none;
            padding: 4px 0;
        }

        .story-notes-collapse summary:hover {
            color: var(--text-secondary);
        }

        .story-notes-collapse[open] summary {
            margin-bottom: 10px;
        }

        .zone-story .story-notes {
            margin: 0;
        }

        /* Zone B: Card Selection (Dominant) */
        .zone-cards {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 32px 16px;
            min-height: 280px;
        }

        .voting-cards-large {
            display: flex;
            flex-wrap: wrap;
            gap: 14px;
            justify-content: center;
            perspective: 1000px;
        }

        .voting-cards-large .vote-card {
            width: var(--card-width);
            height: var(--card-height);
            font-size: 1.6rem;
        }

        .my-vote-indicator {
            margin-top: 24px;
            padding: 10px 24px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            border: 1px solid rgba(16, 185, 129, 0.4);
            border-radius: 50px;
            color: var(--accent-emerald);
            font-weight: 600;
            font-size: 0.9rem;
            display: none;
            align-items: center;
            gap: 8px;
        }

        .my-vote-indicator.show {
            display: flex;
            animation: fadeSlideIn 0.3s ease;
        }

        .vote-prompt {
            margin-top: 24px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        /* Zone C: Participants (Poker Table) */
        .zone-participants {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }

        .zone-participants h4 {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 0 0 16px 0;
            text-align: center;
        }

        .participants-table {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 12px;
            padding: 16px;
            background: radial-gradient(ellipse at center, rgba(16, 185, 129, 0.08) 0%, transparent 70%);
            border-radius: 50% / 30%;
            min-height: 120px;
            position: relative;
        }

        .participants-table::before {
            content: '';
            position: absolute;
            inset: 8px;
            border: 2px dashed rgba(16, 185, 129, 0.15);
            border-radius: 50% / 30%;
            pointer-events: none;
        }

        .participant-chip {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            min-width: 90px;
            width: 90px;
            transition: all 0.3s;
        }

        .participant-chip:hover {
            border-color: rgba(79, 70, 229, 0.3);
            background: rgba(255, 255, 255, 0.05);
        }

        .participant-chip.current-user {
            border-color: rgba(79, 70, 229, 0.5);
            background: rgba(79, 70, 229, 0.08);
        }

        .participant-chip .avatar {
            font-size: 1.8rem;
        }

        .participant-chip .name {
            font-size: 0.75rem;
            color: var(--text-secondary);
            width: 100%;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .participant-chip .vote-indicator {
            width: 44px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 700;
            color: var(--text-muted);
            transition: all 0.3s;
            position: relative;
        }

        /* Not voted: empty dot */
        .participant-chip .vote-indicator.pending::before {
            content: '';
            width: 10px;
            height: 10px;
            border: 2px solid var(--text-muted);
            border-radius: 50%;
            opacity: 0.5;
        }

        /* Voted: filled dot with checkmark */
        .participant-chip .vote-indicator.voted {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(5, 150, 105, 0.15));
            border-color: rgba(16, 185, 129, 0.3);
            color: var(--accent-emerald);
        }

        .participant-chip .vote-indicator.voted::before {
            content: '✓';
            font-size: 1rem;
        }

        .participant-chip .vote-indicator.revealed {
            background: linear-gradient(135deg, rgba(79, 70, 229, 0.15), rgba(99, 102, 241, 0.15));
            border-color: rgba(79, 70, 229, 0.4);
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .participant-chip .vote-indicator.revealed::before {
            content: none;
        }

        /* Chat emoji indicator on vote card */
        .participant-chip .vote-indicator .chat-avatar-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 24px;
            height: 24px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 2px 8px rgba(6, 182, 212, 0.4);
            border: 2px solid var(--bg-primary);
            z-index: 5;
        }

        .participant-chip.has-chatted .vote-indicator .chat-avatar-badge {
            opacity: 1;
            transform: scale(1);
            animation: chat-badge-pop 0.4s ease-out, chat-badge-pulse 2s ease-in-out 0.4s infinite;
        }

        @keyframes chat-badge-pop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        @keyframes chat-badge-pulse {
            0%, 100% { box-shadow: 0 2px 8px rgba(6, 182, 212, 0.4); }
            50% { box-shadow: 0 2px 12px rgba(6, 182, 212, 0.7); }
        }

        /* Click to peek vote effect */
        .participant-chip {
            cursor: pointer;
            position: relative;
        }

        .participant-chip.peek-highlight {
            animation: peek-vote 1.5s ease-out;
        }

        .participant-chip.peek-highlight .vote-indicator {
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(79, 70, 229, 0.5);
            border-color: var(--accent-primary);
            z-index: 10;
        }

        @keyframes peek-vote {
            0% { transform: scale(1); }
            15% { transform: scale(1.05); }
            30% { transform: scale(1); }
            100% { transform: scale(1); }
        }

        /* Contextual Footer: Host Controls */
        .contextual-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(10, 10, 15, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid var(--border-color);
            padding: 16px 24px;
            z-index: 200;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .contextual-footer.show {
            transform: translateY(0);
        }

        .footer-content {
            max-width: 900px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .footer-stats {
            display: flex;
            gap: 24px;
            margin-right: auto;
        }

        .footer-stat {
            text-align: center;
        }

        .footer-stat-value {
            font-size: 1.4rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .footer-stat-label {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .footer-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .footer-lock-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .footer-lock-group select {
            width: auto;
            min-width: 100px;
        }

        /* Add padding to main when footer is shown */
        body.footer-visible .room-main {
            padding-bottom: 100px;
        }

        /* ============================================
           Responsive: Mobile Drawer & Zones
           ============================================ */

        @media (max-width: 768px) {
            .drawer {
                width: 100%;
                border-radius: 20px 20px 0 0;
                border-left: none;
                border-top: 1px solid var(--border-color);
                transform: translateY(100%);
                height: 85vh;
                top: auto;
                bottom: 0;
            }

            .drawer.open {
                transform: translateY(0);
            }

            .drawer-toggle {
                top: auto;
                bottom: 100px;
                right: 16px;
                width: 52px;
                border-radius: 26px;
                border: 1px solid var(--border-color);
                flex-direction: row;
                padding: 8px 12px;
                gap: 10px;
            }

            .drawer-toggle-divider {
                width: 1px;
                height: 16px;
            }

            body.footer-visible .drawer-toggle {
                bottom: 180px;
            }

            .voting-cards-large .vote-card {
                width: var(--card-width-mobile);
                height: var(--card-height-mobile);
                font-size: 1.3rem;
            }

            .room-main {
                padding: 16px;
                gap: 16px;
            }

            .zone-cards {
                min-height: 200px;
                padding: 20px 12px;
            }

            .zone-story {
                padding: 20px;
            }

            .zone-story .story-title {
                font-size: 1.2rem;
            }

            .contextual-footer {
                padding: 14px 16px;
            }

            .footer-stats {
                display: none;
            }

            .footer-content {
                justify-content: center;
            }

            .participant-chip {
                padding: 8px 12px;
                min-width: 70px;
            }

            .participant-chip .avatar {
                font-size: 1.4rem;
            }

            .participant-chip .vote-indicator {
                width: 36px;
                height: 48px;
            }
        }

        /* Hide old two-panel layout */
        .main-content.legacy {
            display: none !important;
        }
    </style>
</head>

<body>
    <!-- Confetti Container -->
    <div class="confetti-container" id="confetti-container"></div>

    <!-- Fortune Cookie Toast -->
    <div class="fortune-toast" id="fortune-toast">
        <div class="fortune-emoji" id="fortune-emoji">🔮</div>
        <div class="fortune-content">
            <div class="fortune-label">Sprint Fortune</div>
            <div class="fortune-text" id="fortune-text">Your estimate is on point!</div>
        </div>
        <button class="fortune-close" id="fortune-close" title="Close">×</button>
    </div>

    <!-- Celebration Overlay -->
    <div class="celebration-overlay" id="celebration-overlay">
        <div class="celebration-message">
            <div class="celebration-emoji" id="celebration-emoji">🎉</div>
            <div class="celebration-text" id="celebration-text">Awesome!</div>
            <div class="celebration-subtext" id="celebration-subtext">Everyone has voted</div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal-overlay hidden" id="qr-modal">
        <div class="modal-box" style="max-width: 360px;">
            <h2>Scan to Join</h2>
            <p style="font-size: 0.9rem; margin-bottom: 20px;">
                Room Code: <strong id="qr-room-code" style="color: var(--accent-cyan);"></strong>
            </p>
            <div id="qr-code" style="display: flex; justify-content: center; margin-bottom: 20px; padding: 16px; background: white; border-radius: 12px;"></div>
            <p style="font-size: 0.8rem; color: var(--text-muted);">Participants can scan this QR code to join instantly</p>
            <button onclick="document.getElementById('qr-modal').classList.add('hidden')" style="margin-top: 16px;">
                Close
            </button>
        </div>
    </div>

    <!-- Name Modal -->
    <div class="modal-overlay" id="name-modal">
        <div class="modal-box">
            <h2>Join Room</h2>
            <p>Enter your name to join the estimation session</p>
            <input type="text" id="name-input" placeholder="Your name" maxlength="24" autofocus>
            <button id="join-btn">Join Session</button>
        </div>
    </div>

    <!-- Purchase Modal (AI Feature) -->
    <div class="purchase-modal-overlay" id="purchase-modal">
        <div class="purchase-modal">
            <div class="purchase-modal-icon">🤖</div>
            <h3>Unlock AI Estimation</h3>
            <p>Get intelligent story point suggestions powered by AI analysis of your story descriptions.</p>
            <div class="purchase-modal-features">
                <ul>
                    <li>AI-powered estimation suggestions</li>
                    <li>Historical data analysis</li>
                    <li>Team velocity insights</li>
                    <li>Complexity pattern detection</li>
                </ul>
            </div>
            <div class="purchase-modal-buttons">
                <button class="purchase-modal-btn secondary" id="purchase-close-btn">Maybe Later</button>
                <button class="purchase-modal-btn primary" id="purchase-upgrade-btn">Coming Soon</button>
            </div>
        </div>
    </div>

    <!-- Edit Story Modal -->
    <div class="edit-modal-overlay" id="edit-story-modal">
        <div class="edit-modal">
            <h3 id="edit-modal-title">Edit Story</h3>
            <div class="locked-notice" id="edit-locked-notice" style="display: none;">
                <span>🔒</span> This story is locked and cannot be edited.
            </div>
            <div class="edit-modal-field">
                <label for="edit-story-title">Story Title</label>
                <input type="text" id="edit-story-title" placeholder="Enter story title..." maxlength="120">
            </div>
            <div class="edit-modal-field">
                <label for="edit-story-notes">Notes <span style="font-weight: 400; color: #94a3b8;">(visible to all participants)</span></label>
                <textarea id="edit-story-notes" placeholder="Add details, acceptance criteria, or discussion notes..." maxlength="1000"></textarea>
            </div>
            <div class="edit-modal-buttons">
                <button class="edit-modal-btn danger" id="delete-story-btn" style="margin-right: auto;">Delete</button>
                <button class="edit-modal-btn secondary" id="edit-cancel-btn">Cancel</button>
                <button class="edit-modal-btn primary" id="edit-save-btn">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Avatar Selector Modal -->
    <div class="avatar-modal-overlay" id="avatar-modal">
        <div class="avatar-modal">
            <h3>Choose Your Avatar</h3>
            <p class="avatar-modal-subtitle">Pick an avatar to represent you in this session</p>
            <div class="avatar-grid" id="avatar-grid">
                <!-- Avatars populated by JS -->
            </div>
            <div class="avatar-modal-footer">
                <button class="avatar-modal-btn secondary" id="avatar-cancel-btn">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div class="error-container" id="error-container">
        <h2>Room Not Found</h2>
        <p id="error-message">The room you're looking for doesn't exist or has expired.</p>
        <a href="/">Back to Home</a>
    </div>

    <!-- Drawer Overlay -->
    <div class="drawer-overlay" id="drawer-overlay"></div>

    <!-- Collapsible Drawer -->
    <aside class="drawer" id="drawer">
        <div class="drawer-header">
            <div class="drawer-tabs" role="tablist">
                <button class="drawer-tab active" data-tab="stories" role="tab" aria-selected="true">Stories</button>
                <button class="drawer-tab" data-tab="settings" role="tab" aria-selected="false">Settings</button>
                <button class="drawer-tab" data-tab="chat" role="tab" aria-selected="false">
                    Chat
                    <span class="drawer-tab-badge" id="drawer-chat-badge"></span>
                </button>
            </div>
            <button class="drawer-close" id="drawer-close" aria-label="Close drawer">&times;</button>
        </div>

        <div class="drawer-content">
            <!-- Stories Tab Panel -->
            <div class="drawer-panel active" id="drawer-panel-stories" role="tabpanel">
                <h4>Stories <span id="drawer-story-count">(0)</span></h4>
                <div class="stories-list" id="drawer-stories-list">
                    <div style="text-align: center; padding: 24px; color: var(--text-muted);">
                        No stories yet
                    </div>
                </div>
                <div class="add-story-form">
                    <input type="text" id="drawer-new-story-input" placeholder="Story title..." maxlength="120">
                    <button class="add-story-btn" id="drawer-add-story-btn">Add</button>
                </div>
                <div class="import-stories" style="margin-top: 12px;">
                    <input type="file" id="drawer-import-file-input" accept=".txt,.csv" style="display: none;">
                    <button class="import-btn" id="drawer-import-btn" title="Import stories from text file (one per line)">
                        <span>📁</span> Import from File
                    </button>
                </div>
            </div>

            <!-- Settings Tab Panel -->
            <div class="drawer-panel" id="drawer-panel-settings" role="tabpanel">
                <!-- Room Info Box -->
                <div class="room-info-box" id="drawer-room-info">
                    <div class="room-info-row">
                        <span class="room-info-label">Room Code</span>
                        <span class="room-info-value" id="drawer-room-code">-</span>
                    </div>
                    <div class="room-info-row">
                        <span class="room-info-label">Status</span>
                        <span class="room-info-value host" id="drawer-host-status">Participant</span>
                    </div>
                </div>

                <!-- Room Settings Section -->
                <div class="drawer-section">
                    <h4>Room Settings</h4>
                    <div class="settings-section">
                        <label>Deck Type <span class="host-only-badge" id="deck-host-badge" style="display: none;">Host only</span></label>
                        <select id="drawer-deck-select" class="form-control">
                            <option value="fibonacci">Fibonacci (0, 1, 2, 3, 5, 8, 13, 21, ?, ☕)</option>
                            <option value="tshirt">T-Shirt (XS, S, M, L, XL, XXL, ?, ☕)</option>
                            <option value="custom">Custom Deck</option>
                        </select>
                    </div>
                    <div id="drawer-custom-deck-input" style="display: none;" class="settings-section">
                        <label>Custom Values (comma-separated)</label>
                        <input type="text" id="drawer-custom-deck-values" class="form-control"
                               placeholder="e.g., 1, 2, 4, 8, 16" maxlength="200">
                        <button type="button" id="drawer-apply-custom-deck" class="host-btn primary" style="margin-top: 10px; width: 100%;">
                            Apply Custom Deck
                        </button>
                    </div>
                    <div class="settings-section">
                        <label class="checkbox-label">
                            <input type="checkbox" id="drawer-fun-mode-toggle">
                            <span>Fun Mode - confetti & celebrations</span>
                        </label>
                    </div>
                </div>

                <!-- Actions Section -->
                <div class="drawer-section">
                    <h4>Actions</h4>
                    <button class="host-btn secondary" id="drawer-export-csv-btn" title="Export stories with estimates to CSV" style="width: 100%;">
                        📊 Export to CSV
                    </button>
                </div>

                <!-- Danger Zone (Host only) -->
                <div class="danger-zone" id="drawer-danger-zone" style="display: none;">
                    <h4>⚠️ Danger Zone <span class="host-only-badge">Host only</span></h4>
                    <button class="danger-zone-btn" id="drawer-finish-btn" title="End session and remove room">
                        🏁 Finish Session
                    </button>
                    <p style="font-size: 0.75rem; color: var(--text-muted); margin-top: 10px; margin-bottom: 0;">
                        This will end the session for all participants.
                    </p>
                </div>
            </div>

            <!-- Chat Tab Panel -->
            <div class="drawer-panel" id="drawer-panel-chat" role="tabpanel">
                <div class="chat-messages" id="drawer-chat-messages">
                    <div class="chat-empty" id="drawer-chat-empty">
                        <div class="chat-empty-icon">💬</div>
                        <div class="chat-empty-title">Quick team notes</div>
                        <div class="chat-empty-subtitle">Discuss differences before locking estimates</div>
                        <div class="chat-quick-chips">
                            <button class="chat-chip" data-message="Why the difference in votes?">Why the difference?</button>
                            <button class="chat-chip" data-message="Any hidden complexity?">Hidden complexity?</button>
                            <button class="chat-chip" data-message="Can we split this story?">Split the story?</button>
                        </div>
                        <div class="chat-privacy-note">
                            Visible to room participants only • Cleared when room expires
                        </div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <input type="text" class="chat-input" id="drawer-chat-input"
                           placeholder="Type a message..." maxlength="500">
                    <button class="chat-send-btn" id="drawer-chat-send-btn">Send</button>
                </div>
            </div>
        </div>
    </aside>

    <!-- Finish Session Confirmation Modal -->
    <div class="confirm-modal-overlay" id="finish-confirm-modal">
        <div class="confirm-modal">
            <div class="confirm-modal-icon">⚠️</div>
            <h3>End this session?</h3>
            <p>This will close the room for all participants. Stories and votes will be lost.</p>
            <input type="text" class="confirm-modal-input" id="finish-confirm-input"
                   placeholder="Type END to confirm" autocomplete="off">
            <div class="confirm-modal-buttons">
                <button class="confirm-modal-btn cancel" id="finish-confirm-cancel">Cancel</button>
                <button class="confirm-modal-btn danger" id="finish-confirm-btn" disabled>End Session</button>
            </div>
        </div>
    </div>

    <!-- Drawer Toggle Button -->
    <button class="drawer-toggle" id="drawer-toggle" aria-label="Open menu">
        <span class="drawer-toggle-item" id="drawer-toggle-stories" title="Stories">
            📋
            <span class="badge-count" id="drawer-toggle-stories-count" style="display: none;"></span>
        </span>
        <span class="drawer-toggle-divider"></span>
        <span class="drawer-toggle-item" id="drawer-toggle-chat" title="Chat">
            💬
            <span class="badge-dot" id="drawer-toggle-chat-dot" style="display: none;"></span>
        </span>
    </button>

    <!-- Contextual Footer: Host Controls -->
    <div class="contextual-footer" id="contextual-footer">
        <div class="footer-content">
            <!-- Stats (shown after reveal) -->
            <div class="footer-stats" id="footer-stats" style="display: none;">
                <div class="footer-stat">
                    <div class="footer-stat-value" id="footer-stat-min">-</div>
                    <div class="footer-stat-label">Min</div>
                </div>
                <div class="footer-stat">
                    <div class="footer-stat-value" id="footer-stat-median">-</div>
                    <div class="footer-stat-label">Median</div>
                </div>
                <div class="footer-stat">
                    <div class="footer-stat-value" id="footer-stat-max">-</div>
                    <div class="footer-stat-label">Max</div>
                </div>
            </div>

            <!-- Actions change based on phase -->
            <div class="footer-actions" id="footer-actions">
                <!-- Phase: Voting -->
                <div id="footer-voting-controls">
                    <button class="host-btn primary" id="footer-reveal-btn">Reveal Votes</button>
                    <button class="host-btn tertiary" id="footer-clear-btn">Clear votes</button>
                </div>

                <!-- Phase: Revealed (hidden by default) -->
                <div id="footer-revealed-controls" style="display: none;">
                    <!-- Quick-pick chips for common values -->
                    <div class="footer-quick-picks" id="footer-quick-picks"></div>
                    <div class="footer-lock-group">
                        <select id="footer-lock-value" class="form-control"></select>
                        <button class="host-btn primary large" id="footer-lock-btn">Lock Estimate</button>
                    </div>
                    <button class="host-btn tertiary" id="footer-revote-btn">Re-vote</button>
                </div>

                <!-- Phase: Locked (hidden by default) -->
                <div id="footer-locked-controls" style="display: none;">
                    <button class="host-btn primary" id="footer-next-btn">Next Story →</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Room UI -->
    <div id="room-ui" style="display: none; flex-direction: column; min-height: 100vh;">
        <header class="room-header">
            <div style="display: flex; align-items: center; gap: 16px;">
                <a href="/" style="text-decoration: none;">
                    <h1>Sprint Story Point</h1>
                </a>
            </div>
            <div class="room-info">
                <div class="connection-status">
                    <span class="status-dot" id="status-dot"></span>
                    <span id="status-text">Connecting...</span>
                </div>
                <span class="room-code" id="room-code"></span>
                <button class="header-btn" id="copy-link-btn">Copy Link</button>
                <button class="header-btn" id="qr-btn" title="Show QR Code">QR</button>
                <div class="share-dropdown" id="share-dropdown">
                    <button class="header-btn" id="share-btn" title="Share">Share</button>
                    <div class="share-menu" id="share-menu">
                        <button class="share-option" id="share-slack">
                            <span>💬</span> Share to Slack
                        </button>
                        <button class="share-option" id="share-teams">
                            <span>👥</span> Share to Teams
                        </button>
                        <button class="share-option" id="share-email">
                            <span>📧</span> Email Invite
                        </button>
                        <button class="share-option" id="share-native">
                            <span>📲</span> More Options...
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- 3-Zone Focused Layout -->
        <main class="room-main">
            <!-- Zone A: Current Story + Phase -->
            <section class="zone-story" id="zone-story">
                <!-- Empty state (shown when no story) -->
                <div id="zone-story-empty" class="empty-state">
                    <p class="empty-message">No story selected</p>
                    <p class="empty-hint">Host adds a story to start voting</p>
                    <div class="empty-action">
                        <button class="open-drawer-btn" onclick="openDrawer('stories')">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                            </svg>
                            Open Stories
                        </button>
                    </div>
                </div>

                <!-- Active story state -->
                <div id="zone-story-active" style="display: none;">
                    <div class="story-header">
                        <div class="story-title-wrapper">
                            <span class="story-number-badge" id="zone-story-number" style="display: none;"></span>
                            <h2 class="story-title" id="zone-story-title" contenteditable="false"></h2>
                            <button class="story-edit-btn" id="zone-story-edit-btn" title="Edit story">✏️</button>
                        </div>
                        <span class="phase-badge phase-voting" id="zone-phase-badge">VOTING</span>
                    </div>

                    <div class="story-progress" id="zone-story-progress">
                        <span class="story-progress-text" id="zone-progress-text">Waiting for votes: 0/0</span>
                        <div class="story-progress-bar">
                            <div class="story-progress-fill" id="zone-progress-fill" style="width: 0%"></div>
                        </div>
                        <button class="invite-link-btn" id="zone-invite-btn" style="display: none;" onclick="copyRoomLink()">Copy Link</button>
                    </div>

                    <!-- Inline stats (shown after reveal) -->
                    <div class="story-stats-inline" id="zone-stats-inline">
                        <div class="stats-inline-item" id="stats-inline-consensus" style="display: none;">
                            <span class="consensus-badge">Consensus reached</span>
                            <span class="stats-inline-value" id="stats-consensus-value"></span>
                        </div>
                        <div id="stats-inline-full" style="display: flex; gap: 20px;">
                            <div class="stats-inline-item">
                                <span class="stats-inline-label">Min</span>
                                <span class="stats-inline-value" id="stats-inline-min">-</span>
                            </div>
                            <div class="stats-inline-item">
                                <span class="stats-inline-label">Median</span>
                                <span class="stats-inline-value" id="stats-inline-median">-</span>
                            </div>
                            <div class="stats-inline-item">
                                <span class="stats-inline-label">Max</span>
                                <span class="stats-inline-value" id="stats-inline-max">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Contextual CTA chips (shown when relevant) -->
                    <div class="context-cta-chips" id="zone-context-chips" style="display: none;">
                        <button class="context-cta-chip discuss" id="chip-discuss" onclick="openDrawer('chat')" style="display: none;">
                            💬 Discuss differences
                        </button>
                    </div>

                    <details class="story-notes-collapse" id="zone-story-notes-wrapper" style="display: none;">
                        <summary>Notes</summary>
                        <div class="story-notes" id="zone-story-notes"></div>
                    </details>
                </div>
            </section>

            <!-- Zone B: Card Selection (Dominant) -->
            <section class="zone-cards" id="zone-cards">
                <div class="voting-cards-large" id="zone-voting-cards">
                    <!-- Cards populated by JS -->
                </div>

                <!-- Vote confirmation -->
                <div class="my-vote-indicator" id="zone-vote-indicator">
                    <span>✓</span> Your vote: <strong id="zone-my-vote-value"></strong>
                </div>

                <!-- Vote prompt (when not voted) -->
                <div class="vote-prompt" id="zone-vote-prompt">Choose a card to vote</div>

                <!-- Emoji Reactions -->
                <div class="emoji-reactions" id="zone-emoji-reactions" style="margin-top: 16px;">
                    <button class="emoji-reaction-btn" data-emoji="👍" title="Thumbs up">👍</button>
                    <button class="emoji-reaction-btn" data-emoji="🎯" title="On target">🎯</button>
                    <button class="emoji-reaction-btn" data-emoji="🤔" title="Thinking">🤔</button>
                    <button class="emoji-reaction-btn" data-emoji="🚀" title="Let's go!">🚀</button>
                    <button class="emoji-reaction-btn" data-emoji="☕" title="Need coffee">☕</button>
                </div>
            </section>

            <!-- Zone C: Participants (Poker Table) -->
            <section class="zone-participants" id="zone-participants">
                <h4>Participants <span id="zone-participant-count">(0)</span></h4>
                <div class="participants-table" id="zone-participants-table">
                    <!-- Participant chips populated by JS -->
                </div>
            </section>
        </main>

        <!-- Legacy main-content (hidden, kept for compatibility) -->
        <div class="main-content legacy" style="display: none !important;">
            <div class="left-panel">
                <div class="panel">
                    <div id="no-story" class="no-story-state" style="display:none;"></div>
                    <div id="active-story" style="display: none;">
                        <div class="story-title" id="current-story-title"></div>
                        <div class="story-notes" id="current-story-notes"></div>
                        <span class="phase-badge" id="phase-badge">VOTING</span>
                        <div class="voting-cards" id="voting-cards"></div>
                        <div class="waiting-count" id="waiting-count"></div>
                        <div class="emoji-reactions" id="emoji-reactions"></div>
                        <div class="stats-panel" id="stats-panel">
                            <div class="stats-grid">
                                <div class="stat-item"><div class="stat-value" id="stat-min">-</div><div class="stat-label">Min</div></div>
                                <div class="stat-item"><div class="stat-value" id="stat-max">-</div><div class="stat-label">Max</div></div>
                                <div class="stat-item"><div class="stat-value" id="stat-median">-</div><div class="stat-label">Median</div></div>
                                <div class="stat-item"><div class="stat-value" id="stat-spread">-</div><div class="stat-label">Spread</div></div>
                            </div>
                        </div>
                        <!-- Legacy host controls - kept for JS compatibility -->
                            <button id="reveal-btn" style="display:none;"></button>
                            <button id="clear-btn" style="display:none;"></button>
                            <button id="next-btn" style="display:none;"></button>
                            <select id="lock-value" style="display:none;"></select>
                            <button id="lock-btn" style="display:none;"></button>
                            <button id="auto-calc-btn" style="display:none;"></button>
                            <button id="ai-suggest-btn" style="display:none;"></button>
                            <button id="export-csv-btn" style="display:none;"></button>
                            <button id="finish-btn" style="display:none;"></button>
                        </div>
                    </div>
                </div>
                <!-- Legacy participants -->
                <div class="panel" style="display:none;">
                    <span id="participant-count"></span>
                    <div id="participants-grid"></div>
                </div>
            </div>
            <div class="right-panel" style="display:none;">
                <!-- Legacy stories -->
                <span id="story-count"></span>
                <div id="stories-list"></div>
                <input type="text" id="new-story-input">
                <button id="add-story-btn"></button>
                <input type="file" id="import-file-input">
                <button id="import-btn"></button>
                <!-- Legacy settings -->
                <div id="settings-panel">
                    <select id="deck-select"></select>
                    <div id="custom-deck-input"><input id="custom-deck-values"><button id="apply-custom-deck"></button></div>
                    <input type="checkbox" id="fun-mode-toggle">
                    <input id="webhook-url"><button id="test-webhook"></button><button id="notify-channel"></button>
                </div>
                <!-- Legacy chat -->
                <div id="chat-panel">
                    <span id="chat-badge"></span>
                    <div id="chat-messages"><div id="chat-empty"></div></div>
                    <input id="chat-input"><button id="chat-send-btn"></button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-container" id="loading-container">
        <div class="loading-spinner"></div>
    </div>

    <script src="scripts/room.js"></script>
</body>

</html>
